name: CD Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Clone, Setup & Restart Voixia
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SSH â†’ Pull & Deploy
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e

            APP_DIR=/home/${{ secrets.EC2_USER }}/voixia
            REPO_URL="https://github.com/${GITHUB_REPOSITORY}.git"

            echo "â†’ Dans $APP_DIR : clone ou mise Ã  jour du repo"
            if [ ! -d "$APP_DIR/.git" ]; then
              git clone "$REPO_URL" "$APP_DIR"
            else
              cd "$APP_DIR"
              git fetch origin main
              git reset --hard origin/main
            fi

            cd "$APP_DIR"

            echo "â†’ VÃ©rification de requirements.txt"
            [ -f requirements.txt ] || { echo "ðŸ›‘ requirements.txt manquant"; exit 1; }

            echo "â†’ CrÃ©ation/activation du venv"
            if [ ! -d .venv ]; then
              python3.11 -m venv .venv
            fi
            source .venv/bin/activate

            echo "â†’ Upgrade pip & installation des dÃ©pendances"
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "â†’ Reload systemd & restart voixia.service"
            sudo systemctl daemon-reload
            sudo systemctl restart voixia.service
